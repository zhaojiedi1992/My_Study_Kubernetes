<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>服务 &mdash; My_Study_Kubernates v1.0 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> My_Study_Kubernates
          </a>
              <div class="version">
                v1.0
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">k8s</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../index.html">1. 概念</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../%E4%BB%BB%E5%8A%A1/index.html">2. 服务</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">My_Study_Kubernates</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>服务</li>
      <li class="wy-breadcrumbs-aside">
              <a href="https://github.com/zhaojiedi1992/My_Study_Kubernates/blob/../edit/master/source/概念/存储/01-服务.rst" class="fa fa-github"> Edit on GitHub</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="id1">
<h1>服务<a class="headerlink" href="#id1" title="Permalink to this headline"></a></h1>
<p>将运行在一组 Pods 上的应用程序公开为网络服务的抽象方法。</p>
<p>k8s为pods提供自己的ip地址，并为一组pod提供相同的dns名字，可以通过他们完成负载均衡。</p>
<section id="service">
<h2>service资源<a class="headerlink" href="#service" title="Permalink to this headline"></a></h2>
<p>逻辑上的一组 Pod，一种可以访问它们的策略 —— 通常称为微服务。 Service 所针对的 Pods 集合通常是通过选择算符来确定的。</p>
</section>
<section id="id2">
<h2>定义service<a class="headerlink" href="#id2" title="Permalink to this headline"></a></h2>
<p>定义service或者一个负载均衡，主要是2个部分， 后端是那些节点，哪个端口还有协议等。
后端是那些节点是可以通过标签选择器来选择即可， 具体的端口需要通过spec.ports来指定的。</p>
</section>
<section id="id3">
<h2>定义service样例<a class="headerlink" href="#id3" title="Permalink to this headline"></a></h2>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos"> 1</span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="linenos"> 2</span><span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="linenos"> 3</span><span class="nt">metadata</span><span class="p">:</span>
<span class="linenos"> 4</span>  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">my-service</span>
<span class="linenos"> 5</span><span class="nt">spec</span><span class="p">:</span>
<span class="linenos"> 6</span>  <span class="nt">selector</span><span class="p">:</span>
<span class="linenos"> 7</span>    <span class="nt">app</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">myapp</span>
<span class="linenos"> 8</span>  <span class="nt">ports</span><span class="p">:</span>
<span class="linenos"> 9</span>  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">80</span>
<span class="linenos">10</span>    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">8080</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 查看创建的服务</span>
kubectl get svc
NAME                                                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>   AGE
glusterfs-dynamic-37d63494-2b84-4820-94c8-20cb328315f5   ClusterIP   <span class="m">10</span>.101.172.236   &lt;none&gt;        <span class="m">1</span>/TCP     8d
glusterfs-dynamic-d6cfa4b3-54d2-4174-b481-e5fb67eed218   ClusterIP   <span class="m">10</span>.109.124.189   &lt;none&gt;        <span class="m">1</span>/TCP     8d
glusterfs-dynamic-de235013-3d3a-42f0-8e39-b094a4761b5e   ClusterIP   <span class="m">10</span>.97.26.122     &lt;none&gt;        <span class="m">1</span>/TCP     8d
kubernetes                                               ClusterIP   <span class="m">10</span>.96.0.1        &lt;none&gt;        <span class="m">443</span>/TCP   13d
my-service                                               ClusterIP   <span class="m">10</span>.98.65.196     &lt;none&gt;        <span class="m">80</span>/TCP    4s
nginxsvc                                                 ClusterIP   None             &lt;none&gt;        <span class="m">80</span>/TCP    9d
<span class="c1"># 查看创建的endpoint</span>
kubectl get ep
NAME                                                     ENDPOINTS                                        AGE
glusterfs-dynamic-37d63494-2b84-4820-94c8-20cb328315f5   <span class="m">10</span>.157.89.216:1,10.157.31.40:1,10.157.89.215:1   8d
glusterfs-dynamic-d6cfa4b3-54d2-4174-b481-e5fb67eed218   &lt;none&gt;                                           8d
glusterfs-dynamic-de235013-3d3a-42f0-8e39-b094a4761b5e   <span class="m">10</span>.157.89.216:1,10.157.31.40:1,10.157.89.215:1   8d
kubernetes                                               <span class="m">10</span>.157.89.215:6443                               13d
my-service                                               &lt;none&gt;                                           9s
nginxsvc                                                 <span class="m">10</span>.244.1.10:80,10.244.2.9:80                     9d
</pre></div>
</div>
</section>
<section id="id4">
<h2>没有选择符的service<a class="headerlink" href="#id4" title="Permalink to this headline"></a></h2>
<p>这种主要适用在如下几个场景中。</p>
<ul class="simple">
<li><p>生产环境使用外部的数据库</p></li>
<li><p>服务在另外一个ns中，或者别的集群中。</p></li>
<li><p>服务迁移k8s中间阶段，部分服务还在非k8s中。</p></li>
</ul>
</section>
<section id="id5">
<h2>创建外部服务过程<a class="headerlink" href="#id5" title="Permalink to this headline"></a></h2>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="linenos">2</span><span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Service</span>
<span class="linenos">3</span><span class="nt">metadata</span><span class="p">:</span>
<span class="linenos">4</span>  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mydb</span>
<span class="linenos">5</span><span class="nt">spec</span><span class="p">:</span>
<span class="linenos">6</span>  <span class="nt">ports</span><span class="p">:</span>
<span class="linenos">7</span>  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3306</span>
<span class="linenos">8</span>    <span class="nt">targetPort</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3306</span>
</pre></div>
</div>
<div class="highlight-yaml notranslate"><div class="highlight"><pre><span></span><span class="linenos">1</span><span class="nt">apiVersion</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">v1</span>
<span class="linenos">2</span><span class="nt">kind</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">Endpoints</span>
<span class="linenos">3</span><span class="nt">metadata</span><span class="p">:</span>
<span class="linenos">4</span>  <span class="nt">name</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">mydb</span>
<span class="linenos">5</span><span class="nt">subsets</span><span class="p">:</span>
<span class="linenos">6</span><span class="p p-Indicator">-</span> <span class="nt">addresses</span><span class="p">:</span> 
<span class="linenos">7</span>  <span class="p p-Indicator">-</span> <span class="nt">ip </span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.0.5</span>
<span class="linenos">8</span>  <span class="nt">ports</span><span class="p">:</span> 
<span class="linenos">9</span>  <span class="p p-Indicator">-</span> <span class="nt">port</span><span class="p">:</span> <span class="l l-Scalar l-Scalar-Plain">3306</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># 查看服务</span>
kubectl get svc
NAME                                                     TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>    AGE
glusterfs-dynamic-37d63494-2b84-4820-94c8-20cb328315f5   ClusterIP   <span class="m">10</span>.101.172.236   &lt;none&gt;        <span class="m">1</span>/TCP      8d
glusterfs-dynamic-d6cfa4b3-54d2-4174-b481-e5fb67eed218   ClusterIP   <span class="m">10</span>.109.124.189   &lt;none&gt;        <span class="m">1</span>/TCP      8d
glusterfs-dynamic-de235013-3d3a-42f0-8e39-b094a4761b5e   ClusterIP   <span class="m">10</span>.97.26.122     &lt;none&gt;        <span class="m">1</span>/TCP      8d
kubernetes                                               ClusterIP   <span class="m">10</span>.96.0.1        &lt;none&gt;        <span class="m">443</span>/TCP    13d
my-service                                               ClusterIP   <span class="m">10</span>.98.65.196     &lt;none&gt;        <span class="m">80</span>/TCP     11m
mydb                                                     ClusterIP   <span class="m">10</span>.98.213.29     &lt;none&gt;        <span class="m">3306</span>/TCP   65s
nginxsvc                                                 ClusterIP   None             &lt;none&gt;        <span class="m">80</span>/TCP     9d
<span class="c1"># 查看endpoint</span>
kubectl get ep
NAME                                                     ENDPOINTS                                        AGE
glusterfs-dynamic-37d63494-2b84-4820-94c8-20cb328315f5   <span class="m">10</span>.157.89.216:1,10.157.31.40:1,10.157.89.215:1   8d
glusterfs-dynamic-d6cfa4b3-54d2-4174-b481-e5fb67eed218   &lt;none&gt;                                           8d
glusterfs-dynamic-de235013-3d3a-42f0-8e39-b094a4761b5e   <span class="m">10</span>.157.89.216:1,10.157.31.40:1,10.157.89.215:1   8d
kubernetes                                               <span class="m">10</span>.157.89.215:6443                               13d
my-service                                               &lt;none&gt;                                           11m
mydb                                                     <span class="m">192</span>.168.0.5:3306                                 21s
nginxsvc                                                 <span class="m">10</span>.244.1.10:80,10.244.2.9:80                     9d
</pre></div>
</div>
</section>
<section id="endpoint">
<h2>超出容量的endpoint<a class="headerlink" href="#endpoint" title="Permalink to this headline"></a></h2>
<p>如果某个ep资源超过1000的话，会被截断的， 另外添加一个注解。endpoints.kubernetes.io/over-capacity: truncated。</p>
</section>
<section id="ip-service">
<h2>虚拟 IP 和 Service 代理<a class="headerlink" href="#ip-service" title="Permalink to this headline"></a></h2>
<p>在k8s中，每个node是运行一个kube-proxy进程的，kube-proxy负责为service实现一种vip的形式。</p>
<p>为啥不使用dns轮训</p>
<ul class="simple">
<li><p>不遵守记录ttl设置</p></li>
<li><p>无限期缓存</p></li>
<li><p>大量解析会是的dns高负载</p></li>
</ul>
<p>userspace 代理模式</p>
<p>iptables 代理模式</p>
<p>IPVS 代理模式</p>
<p>在ipvs模式下，kube-proxy会监视k8s的服务和端点，调用netLink接口完成创建ipvs规则，并定期同步。访问服务的时候流量定向到具体后端pod之一。</p>
<p>ipvs大力模式类似于iptables模式的netfilter挂钩函数，但是使用哈希表作为基础数据结构。兵器在内核空间工作，延迟更短，支持更高的网络流量吞吐量。</p>
<p>支持多种流量调度算法</p>
<ul class="simple">
<li><p>rr：轮替（Round-Robin）</p></li>
<li><p>lc：最少链接（Least Connection），即打开链接数量最少者优先</p></li>
<li><p>dh：目标地址哈希（Destination Hashing）</p></li>
<li><p>sh：源地址哈希（Source Hashing）</p></li>
<li><p>sed：最短预期延迟（Shortest Expected Delay）</p></li>
<li><p>nq：从不排队（Never Queue）</p></li>
</ul>
<dl class="simple">
<dt>会话粘性</dt><dd><p>service.spec.sessionAffinity 设置为 “ClientIP” （默认值是 “None”），来基于客户端的 IP 地址选择会话关联。
service.spec.sessionAffinityConfig.clientIP.timeoutSeconds 来设置最大会话停留时间</p>
</dd>
</dl>
</section>
<section id="id6">
<h2>多端口service<a class="headerlink" href="#id6" title="Permalink to this headline"></a></h2>
<p>多端口server建议给server.ports[*].name进行指定，减少端口歧义。</p>
</section>
<section id="id7">
<h2>服务发现<a class="headerlink" href="#id7" title="Permalink to this headline"></a></h2>
<p>k8s支持2中基本的服务于发现模式，环境变量和dns。</p>
<section id="id8">
<h3>环境变量<a class="headerlink" href="#id8" title="Permalink to this headline"></a></h3>
<p>当 Pod 运行在 Node 上，kubelet 会为每个活跃的 Service 添加一组环境变量。 它同时支持 Docker links兼容 变量 （查看 makeLinkVariables）、
简单的 {SVCNAME}_SERVICE_HOST 和 {SVCNAME}_SERVICE_PORT 变量。 这里 Service 的名称需大写，横线被转换成下划线。</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>pod使用环境变量前，这个服务必须是有的，没有没法使用。</p>
</div>
</section>
<section id="dns">
<h3>DNS<a class="headerlink" href="#dns" title="Permalink to this headline"></a></h3>
<p>支持集群的 DNS 服务器（例如 CoreDNS）监视 Kubernetes API 中的新服务，并为每个服务创建一组 DNS 记录。 如果在整个集群中都启用了 DNS，则所有 Pod 都应该能够通过其 DNS 名称自动解析服务。</p>
<p>Kubernetes DNS 服务器是唯一的一种能够访问 ExternalName 类型的 Service 的方式。</p>
</section>
</section>
<section id="id9">
<h2>无头服务<a class="headerlink" href="#id9" title="Permalink to this headline"></a></h2>
<p>有时不需要或不想要负载均衡，以及单独的 Service IP。 遇到这种情况，可以通过指定 Cluster IP（spec.clusterIP）的值为 “None” 来创建 Headless Service。</p>
<ul class="simple">
<li><p>带选择符的服务： ，Endpoint 控制器在 API 中创建了 Endpoints 记录， 并且修改 DNS 配置返回 A 记录</p></li>
<li><p>无选择符的服务： 不会创建endpoint记录，externalName会查询cname记录，其他的会查询同名endpoint。</p></li>
</ul>
</section>
<section id="id10">
<h2>发布服务（服务类型)<a class="headerlink" href="#id10" title="Permalink to this headline"></a></h2>
<p>service的类型比较多的。
主要是如下几种。</p>
<ul class="simple">
<li><p>ClusterIP：通过集群的内部 IP 暴露服务，选择该值时服务只能够在集群内部访问。 这也是默认的 ServiceType。</p></li>
<li><p>NodePort：通过每个节点上的 IP 和静态端口（NodePort）暴露服务。 NodePort 服务会路由到自动创建的 ClusterIP 服务。 通过请求 &lt;节点 IP&gt;:&lt;节点端口&gt;，你可以从集群的外部访问一个 NodePort 服务。</p></li>
<li><p>LoadBalancer：使用云提供商的负载均衡器向外部暴露服务。 外部负载均衡器可以将流量路由到自动创建的 NodePort 服务和 ClusterIP 服务上。</p></li>
<li><p>ExternalName：通过返回 CNAME 和对应值，可以将服务映射到 externalName 字段的内容（例如，foo.bar.example.com）。 无需创建任何类型代理。</p></li>
</ul>
</section>
<section id="id11">
<h2>支持的协议<a class="headerlink" href="#id11" title="Permalink to this headline"></a></h2>
<ul class="simple">
<li><p>tcp</p></li>
<li><p>udp</p></li>
<li><p>sctp</p></li>
<li><p>HTTP</p></li>
<li><p>Proxy</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2018, zhaojiedi1992@outlook.com.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>